<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Emoji Road ‚Äì Zoo & Phoenix Massive Update</title>
<style>
:root{
  --bg1:#0b0c12;
  --bg2:#0f0f13;
  --panel:#171922;
  --panel-soft:#121421;
  --road:#cc1f1f;
  --text:#e9ecf1;
}
*{box-sizing:border-box;-webkit-user-select:none;user-select:none}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  color:var(--text);
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
}

/* header + layout bar */
header{
  padding:8px 10px;
  background:#10121a;
  border-bottom:1px solid #232738;
  display:flex;
  gap:6px;
  align-items:center;
  flex-wrap:wrap;
  font-size:13px;
}
.stat{
  padding:4px 8px;
  background:#171922;
  border:1px solid #232738;
  border-radius:10px;
  font-weight:600;
}
.btn{
  appearance:none;
  border:1px solid #2b3044;
  background:#1e2231;
  color:var(--text);
  padding:6px 8px;
  border-radius:10px;
  cursor:pointer;
  font-weight:700;
  font-size:12px;
}
.btn:hover{filter:brightness(1.08)}

.layout-bar{
  padding:6px 10px;
  background:#10121a;
  border-bottom:1px solid #232738;
  display:flex;
  flex-wrap:wrap;
  gap:4px;
  align-items:center;
  font-size:12px;
}
.layout-bar .btn{
  font-size:11px;
  padding:4px 6px;
}
.layout-btn.locked{
  opacity:0.3;
  pointer-events:none;
}

/* main layout */
.wrap{
  display:grid;
  grid-template-columns:320px 1fr;
  gap:10px;
  padding:10px;
}
@media(max-width:900px){.wrap{grid-template-columns:1fr}}

aside,main{
  background:var(--panel);
  border:1px solid #232738;
  border-radius:14px;
}
aside{
  padding:10px;
  max-height:calc(100vh - 120px);
  overflow:auto;
}
aside h2,main h2{
  margin:4px 0 8px;
  font-size:15px;
  color:#cbd5e1;
}
.section-title{
  margin-top:8px;
  font-size:13px;
  font-weight:700;
  color:#e2e8f0;
}
.small{font-size:12px;color:var(--muted,#aab3c0)}

/* legend */
.legend{
  display:grid;
  gap:4px;
  grid-template-columns:repeat(2,minmax(0,1fr));
}
.legend .row{
  display:flex;
  justify-content:space-between;
  gap:4px;
  padding:4px 6px;
  border-radius:9px;
  background:#121421;
  border:1px solid #20233a;
  font-size:12px;
}
.chip{
  padding:2px 6px;
  border-radius:999px;
  font-weight:800;
  color:#0d0f16;
  font-size:11px;
}

/* road */
.road-wrap{
  position:relative;
  padding:8px;
  height:360px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
@media(max-width:600px){.road-wrap{height:50vh}}
.road{
  position:relative;
  flex:1;
  border-radius:14px;
  background:var(--road,#cc1f1f);
  overflow:hidden;
  border:2px solid #801919;
  box-shadow:inset 0 0 30px rgba(0,0,0,.35);
  touch-action:manipulation;
}
.lane{
  position:absolute;
  left:0;right:0;
  height:3px;
  background:repeating-linear-gradient(90deg,#ffd9d9 0 30px,transparent 30px 60px);
  opacity:.35;
  pointer-events:none;
}
.lane:nth-child(1){top:33%}
.lane:nth-child(2){top:50%}
.lane:nth-child(3){top:67%}

.spawn{
  position:absolute;
  font-size:28px;
  line-height:1;
  cursor:pointer;
  touch-action:manipulation;
  -webkit-tap-highlight-color:transparent;
  padding:8px;
  border-radius:10px;
  filter:drop-shadow(0 2px 0 rgba(0,0,0,.25));
  transform:translateY(-50%);
}
.tag{
  position:absolute;
  top:-18px;
  left:50%;
  transform:translateX(-50%);
  padding:2px 6px;
  border-radius:999px;
  font-size:10px;
  white-space:nowrap;
  font-weight:800;
  color:#0d0f16;
}

/* base */
.base{
  padding:8px;
  display:grid;
  gap:8px;
  grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
}
.card{
  background:var(--panel-soft);
  border:1px solid #20233a;
  border-radius:12px;
  padding:8px;
  display:flex;
  gap:8px;
  align-items:flex-start;
  font-size:13px;
}
.card .big{font-size:30px}
.card h4{margin:0;font-size:13px}
.row-btns{
  display:flex;
  gap:4px;
  flex-wrap:wrap;
  margin-top:4px;
}
.btn-mini{
  border:1px solid #2b3044;
  background:#171b29;
  color:#d7deea;
  padding:4px 6px;
  border-radius:7px;
  cursor:pointer;
  font-size:11px;
  font-weight:700;
}
.btn-mini.sell{background:#25161a;border-color:#5a2631}
.btn-mini.feed{background:#14231c;border-color:#264d3a}
.btn-mini.open{background:#1d2234;border-color:#33406a}
.btn-mini.buy{background:#16211f;border-color:#264d3a}
.btn-mini.trade{background:#231c32;border-color:#413066}
.btn-mini.luck{background:#112623;border-color:#1f4c44}
.btn-mini.zoo{background:#1c2430;border-color:#30435f}
.btn-mini.door{background:#26152a;border-color:#553153}

/* toast */
.toast{
  position:fixed;
  right:10px;
  bottom:10px;
  display:flex;
  flex-direction:column-reverse;
  gap:6px;
  z-index:9999;
  font-size:13px;
}
.toast .t{
  background:#0e111b;
  border:1px solid #303653;
  padding:8px 10px;
  border-radius:9px;
  box-shadow:0 10px 30px rgba(0,0,0,.4);
  max-width:300px;
}

/* workshops */
.workshops{padding:8px;border-top:1px solid #232738}
.ws{
  background:#101423;
  border:1px solid #232738;
  border-radius:12px;
  padding:8px;
  margin-bottom:8px;
}
.ws h3{margin:0 0 4px;font-size:14px}
.pill{
  display:inline-block;
  padding:2px 6px;
  border-radius:999px;
  background:#0e152b;
  border:1px solid #2a3a64;
  margin-right:4px;
  font-size:11px;
}

/* dealer / trader / zoo */
.dealer-grid,.trader-grid,#zooShop{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(130px,1fr));
  gap:4px;
  margin-top:4px;
}
.dealer-card,.trader-card,.zoo-card{
  background:#101423;
  border-radius:10px;
  border:1px solid #232738;
  padding:6px;
  font-size:11px;
}
.dealer-card-emoji,.trader-card-emoji,.zoo-emoji{
  font-size:20px;
  margin-bottom:2px;
}

/* index */
.index-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(24px,1fr));
  gap:3px;
  margin-top:4px;
}
.index-cell{
  border-radius:6px;
  padding:2px 0;
  text-align:center;
  font-size:14px;
  background:#050816;
  opacity:0.3;
}
.index-cell.owned{
  opacity:1;
  background:#1e293b;
}

/* animations / rarity colors */
@keyframes pop{from{transform:scale(1)}50%{transform:scale(1.05)}to{transform:scale(1)}}
.money-up{animation:pop .5s ease}
.glowwhite{filter:drop-shadow(0 0 4px #fff) drop-shadow(0 0 12px #fff)}

.r-Common{background:#e5ecf6}
.r-Uncommon{background:#b6f3c9}
.r-Rare{background:#a3d0ff}
.r-Epic{background:#c8a9ff}
.r-Legendary{background:#ffd176}
.r-Mythical{background:#ff9ed1}
.r-Godly{background:#ff7f7f}
.r-Secret{background:#9bf4ff}
.r-Troll{background:#ffdf8f}
.r-Exotic{background:#baff9f}
.r-Ultra\ Exotic{background:#fff59b}
.r-Insane{background:#ffb39b}
.r-Transcendent{background:#9bffe7}
.r-INSANELY\ TRANSCENDENT{background:#ffffff}
.r-Newgen{background:linear-gradient(90deg,#fff8d1,#b5ffef)}
.r-OG{background:linear-gradient(90deg,#fff,#ffd859,#fff);color:#111}
.r-Godly\ Lucky\ Block{background:#ffd1d1}
.r-Secret\ Lucky\ Block{background:#d1f7ff}
.r-Insane\ Lucky\ Block{background:#ffc6b5}
.r-Mythic\ Lucky\ Block{background:#ffe0ff}
.r-Trick\ Door{background:#fdd3ff}

/* event visuals */
body[data-event="volcano"] .card .big{
  text-shadow:0 0 6px #f97316,0 0 14px #ef4444;
}
@keyframes discoRoad{
  0%{background:#ec4899;}
  25%{background:#8b5cf6;}
  50%{background:#22c55e;}
  75%{background:#eab308;}
  100%{background:#06b6d4;}
}
body[data-event="disco"] .road{
  animation:discoRoad 1s linear infinite alternate;
}
</style>
</head>
<body>
<header>
  <div class="stat" id="cashStat">$0</div>
  <div class="stat" id="rateStat">0 / sec</div>
  <div class="stat" id="rebirthStat">Rebirths: 0 (x1.00)</div>
  <div class="stat" id="luckStat">Luck: 1x</div>
  <div class="stat" id="safariStat">Safari: 0</div>
  <div class="stat" id="eventStat">Event: none</div>
  <button class="btn" id="pauseBtn">Pause</button>
  <button class="btn" id="rebirthBtn">Rebirth</button>
  <button class="btn" id="phoenixBtn">Phoenix Rebirth</button>
</header>

<div class="layout-bar">
  <span class="small">Layouts:</span>
  <button class="btn layout-btn" data-layout="blue">Blue</button>
  <button class="btn layout-btn" data-layout="red">Red</button>
  <button class="btn layout-btn" data-layout="white">White</button>
  <button class="btn layout-btn" data-layout="fruit">Fruit</button>
  <button class="btn layout-btn" data-layout="neon">Neon</button>
  <button class="btn layout-btn" data-layout="rainbow">Rainbow</button>
  <button class="btn layout-btn" data-layout="magma">Magma</button>
  <button class="btn layout-btn" data-layout="ruby">Ruby</button>
  <button class="btn layout-btn" data-layout="blue67">Blue 67</button>
  <button class="btn layout-btn" data-layout="underwater">Underwater</button>
  <button class="btn layout-btn" data-layout="black61">Black Red 61</button>
  <button class="btn layout-btn" data-layout="future">Futuristic</button>
</div>

<div class="wrap">
  <aside>
    <h2>Rarities</h2>
    <div class="legend" id="legend"></div>

    <div class="section-title">Dealer (3 min, up to 10 each)</div>
    <div class="small" id="dealerStatus">Restocking‚Ä¶</div>
    <div class="dealer-grid" id="dealerGrid"></div>

    <div class="section-title">Trader (1 trade)</div>
    <div class="small" id="traderStatus">Trader away.</div>
    <div class="trader-grid" id="traderGrid"></div>

    <div class="section-title">Mr Luck üçÄ</div>
    <div class="small">15-min luck boosts for high rarities.</div>
    <div id="luckShop"></div>

    <div class="section-title">Potions</div>
    <div class="small">Temporary global effects.</div>
    <div id="potionShop"></div>

    <div class="section-title">Zoo (Safari Tokens)</div>
    <div class="small" id="safariInfo">Safari Tokens: 0</div>
    <div id="zooShop"></div>
    <div class="small" id="zooOwned" style="margin-top:4px;">Animals: none</div>

    <div class="section-title">Achievements</div>
    <div class="small" id="achievementsBox">None yet.</div>

    <div class="section-title">Index</div>
    <div class="small" id="indexSummary">0 / 0 collected</div>
    <div id="indexGrid" class="index-grid"></div>
  </aside>

  <main>
    <div class="road-wrap">
      <h2 style="padding:0 4px">Red Road ‚Äî tap to buy</h2>
      <div class="road" id="road">
        <div class="lane"></div>
        <div class="lane"></div>
        <div class="lane"></div>
      </div>
    </div>

    <div class="base-wrap">
      <h2 style="padding:8px">Your Base</h2>
      <div class="base" id="base"></div>

      <div class="workshops">
        <div class="ws">
          <h3>üî∑ Fuse Machine</h3>
          <div class="small">Pick 4 of same rarity ‚Üí 1 next rarity.</div>
          <div class="small" id="fuseHint"></div>
          <div id="fuseList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:6px;margin:6px 0;"></div>
          <span class="pill" id="fuseCountPill">Selected: 0/4</span>
          <button class="btn" id="fuseBtn">Fuse</button>
        </div>

        <div class="ws">
          <h3>üõ†Ô∏è Craft Machine</h3>
          <div class="small">Special recipes (can‚Äôt spawn on road):</div>
          <div id="craftList" style="margin-top:4px;display:grid;gap:4px;"></div>
        </div>

        <div class="ws">
          <h3>üêâ Dragon Lord Shrine</h3>
          <div class="small">Feed 1 Beef ü•© (Mythic) for a tiny chance at Dragon üêâ (INSANELY TRANSCENDENT) and a Dragon Awakening event.</div>
          <button class="btn-mini" id="dragonBtn">Offer Beef</button>
          <span class="pill small" id="beefCountPill">Beef: 0</span>
        </div>
      </div>
    </div>
  </main>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== tiny sound ===== */
let audioCtx=null;
function ac(){if(!audioCtx){try{audioCtx=new (window.AudioContext||window.webkitAudioContext)();}catch(e){}}return audioCtx;}
function beep(f=440,d=0.1,v=0.12){
  const c=ac();if(!c)return;
  const o=c.createOscillator(),g=c.createGain();
  o.type='square';o.frequency.value=f;
  o.connect(g);g.connect(c.destination);
  const t=c.currentTime;
  g.gain.value=0.0001;
  g.gain.exponentialRampToValueAtTime(v,t+0.01);
  g.gain.exponentialRampToValueAtTime(0.0001,t+d);
  o.start(t);o.stop(t+d+0.02);
}
const sClick=()=>beep(520,0.08,0.08);
const sBuy=()=>beep(720,0.12,0.12);
const sRare=()=>beep(880,0.16,0.12);

/* ===== data ===== */
const rarities=[
  {name:'Common',rate:1,cost:10,weight:520},
  {name:'Uncommon',rate:3,cost:40,weight:240},
  {name:'Rare',rate:8,cost:150,weight:110},
  {name:'Epic',rate:20,cost:500,weight:55},
  {name:'Legendary',rate:60,cost:2200,weight:16},
  {name:'Mythical',rate:160,cost:8000,weight:6},
  {name:'Godly',rate:420,cost:30000,weight:3},
  {name:'Secret',rate:1000,cost:120000,weight:1.3},
  {name:'Troll',rate:9000,cost:600000,weight:0},
  {name:'Exotic',rate:2500,cost:400000,weight:0.8},
  {name:'Ultra Exotic',rate:6000,cost:1200000,weight:0.45},
  {name:'Insane',rate:15000,cost:4000000,weight:0.25},
  {name:'Transcendent',rate:42000,cost:12000000,weight:0.12},
  {name:'INSANELY TRANSCENDENT',rate:120000,cost:55000000,weight:0.05},
  {name:'Newgen',rate:220000,cost:110000000,weight:0.03},
  {name:'OG',rate:400000,cost:200000000,weight:0.01},
  {name:'Godly Lucky Block',rate:0,cost:150000,weight:1.0},
  {name:'Secret Lucky Block',rate:0,cost:350000,weight:0.6},
  {name:'Insane Lucky Block',rate:0,cost:900000,weight:0.25},
  {name:'Mythic Lucky Block',rate:0,cost:250000,weight:0.8},
  {name:'Trick Door',rate:0,cost:45000,weight:0.4}
];
const rarityByName=n=>rarities.find(r=>r.name===n);

const nichePool=['üö°','üö†','‚òîÔ∏è','ü™´','üßó‚Äç‚ôÇÔ∏è','üß¨','üõ∞Ô∏è','üß™','üõü','üßä','ü•∂','üßØ','üß≤','üõ¢Ô∏è','üõó','üõ§Ô∏è','üß≠','ü™µ','ü™ô'];
const commonPool=['üòÄ','üôÅ','ü¶ä','üê±','üê≠','üêπ','üêº','üêß','üê§','üåø','üçâ','üçî','üçü','üç™','üç©','‚öΩÔ∏è','üèÄ','üé≤','üéà','üéÆ','üì¶','‚≠êÔ∏è','üíé','üî•','üåà','üåô'];
const OG_TEXT_POOL=[':3','$','*','(:','¬•','¬£','‚Ç¨','¬ß','%'];
const insanelyTransPool=['üå†','üì≤','üñ≤Ô∏è','üïπÔ∏è','üí∏','üìü','ü™¨','üíÆ','üëÅÔ∏è‚Äçüó®Ô∏è','üéÜ','‚õΩÔ∏è']; // dragon removed from road

// Fruits (for Fruit base)
const FRUITS=['üçè','üçé','üçê','üçä','üçã','üçì','üçá','üçâ','üçå','üçã‚Äçüü©','ü´ê','üçà','üçí','üçë','ü•≠','üçÜ','üçÖ','ü•ù','ü••','üçç','ü•ë','ü´õ','ü•¶','ü•¨','ü•í','üå∂Ô∏è','ü´ë','üåΩ','ü•ï','ü´í','üç†','ü´ú','ü•î','üßÖ','üßÑ'];

// ocean set for Underwater base
const OCEAN_SET=['ü¶ê','ü¶û','ü¶Ä','üê°','ü¶ë','üêô','üê¨','üê≥'];

// Zoo animals (cannot spawn on road)
const zooAnimals=[
 'ü¶Ç','ü™≥','ü™≤','üêõ','ü™∞','üï∑Ô∏è','ü¶é','ü¶ç','ü¶ì','ü¶õ','ü¶è','ü¶¨','ü¶ò','ü´è','üêé','ü¶ô','üêê','üêä','ü¶ß','üê™','üêÉ','üêñ','üê©','üêë','üêï','üêè','üêà‚Äç‚¨õ','ü¶§','ü¶ö',
 'üêá','üïäÔ∏è','ü¶´','üêøÔ∏è','ü¶î','ü¶¶','ü¶•','ü¶ù','ü¶ú','üêì','ü¶¢','ü¶®','üêÅ','üêÄ','ü¶°','ü¶ê','ü¶û','ü¶Ä','üê°','ü¶ë','üêô','ü¶ï','ü¶ü','üêû','üêù','üêó','üê∫','ü¶â','ü¶Ö',
 'üê¥','ü¶Ñ','ü¶ã','üêç','üê¨','üê≥'
];
const zooPrices={};zooAnimals.forEach((e,i)=>{zooPrices[e]=5+Math.floor(i/4)*5;}); // gets pricier
const tRexEmoji='ü¶ñ';
zooPrices[tRexEmoji]=1500; // T-rex: 1500 safari

const LUCKY_SETS={
  'Godly Lucky Block' :[{r:'Godly',w:60},{r:'Secret',w:24},{r:'Exotic',w:10},{r:'Ultra Exotic',w:4},{r:'Insane',w:2}],
  'Secret Lucky Block':[{r:'Secret',w:55},{r:'Exotic',w:22},{r:'Ultra Exotic',w:12},{r:'Insane',w:7},{r:'Transcendent',w:3},{r:'INSANELY TRANSCENDENT',w:1}],
  'Insane Lucky Block':[ {r:'Insane',w:65},{r:'Transcendent',w:22},{r:'INSANELY TRANSCENDENT',w:13}],
  'Mythic Lucky Block':[ {r:'Mythical',w:60},{r:'Godly',w:25},{r:'Secret',w:10},{r:'Exotic',w:5}]
};

// Trick Door loot
function openDoorLoot(){
  const r=Math.random()*100;
  if(r<75) return {emoji:'üç¨',rarity:'Mythical'};
  if(r<96) return {emoji:'üç≠',rarity:'Godly'};
  if(r<101) return {emoji:'üç´',rarity:'Secret'};
  if(r<102) return {emoji:'üçß',rarity:'Exotic'};
  if(r<102.5) return {emoji:'üëª',rarity:'Transcendent'};
  return {emoji:'üç¨',rarity:'Mythical'};
}

/* ===== state ===== */
let money=0,rebirths=0,multiplier=1,nextId=1,paused=false;
let currentLuck=1,luckUntil=0;
let safariTokens=0;
let achievements={phoenix:false};
let dealerStock=[],traderStock=[],traderActive=false;
let layoutMode='red';
let unlockFlags={ruby:false,blue67:false};
let collectedEmojis=new Set();
let indexAllEmojis=[];
let eventMultiplier=1;
let activeEvent=null;
let eventUntil=0;
let spawnBoostUntil=0;

const owned=new Map(); // {id,emoji,rarity,baseRate,level,isAnimal,isDoor}

const toastEl=document.getElementById('toast');
const roadEl=document.getElementById('road');
const baseEl=document.getElementById('base');
const cashStat=document.getElementById('cashStat');
const rateStat=document.getElementById('rateStat');
const rebirthStat=document.getElementById('rebirthStat');
const luckStat=document.getElementById('luckStat');
const safariStat=document.getElementById('safariStat');
const dealerStatus=document.getElementById('dealerStatus');
const dealerGrid=document.getElementById('dealerGrid');
const traderStatus=document.getElementById('traderStatus');
const traderGrid=document.getElementById('traderGrid');
const fuseListEl=document.getElementById('fuseList');
const fuseBtn=document.getElementById('fuseBtn');
const fuseCountPill=document.getElementById('fuseCountPill');
const fuseHint=document.getElementById('fuseHint');
const craftList=document.getElementById('craftList');
const luckShop=document.getElementById('luckShop');
const potionShop=document.getElementById('potionShop');
const safariInfo=document.getElementById('safariInfo');
const zooShop=document.getElementById('zooShop');
const zooOwned=document.getElementById('zooOwned');
const achievementsBox=document.getElementById('achievementsBox');
const dragonBtn=document.getElementById('dragonBtn');
const beefCountPill=document.getElementById('beefCountPill');
const phoenixBtn=document.getElementById('phoenixBtn');
const eventStat=document.getElementById('eventStat');
const indexSummary=document.getElementById('indexSummary');
const indexGrid=document.getElementById('indexGrid');
const layoutButtons=document.querySelectorAll('.layout-btn');

/* ===== UI hooks ===== */
document.getElementById('pauseBtn').onclick=()=>{paused=!paused;notify(paused?'Paused':'Resumed',true);};
document.getElementById('rebirthBtn').onclick=doRebirth;
roadEl.addEventListener('pointerdown',e=>{
  const span=e.target.closest('.spawn');if(!span||!roadEl.contains(span))return;
  e.preventDefault();sClick();tryBuy(span);
},{passive:false});

/* layout button clicks */
layoutButtons.forEach(btn=>{
  btn.addEventListener('click',()=>{
    const mode=btn.dataset.layout;
    layoutMode=mode;
    applyLayout();
  });
});

/* legend */
(function(){
  const holder=document.getElementById('legend');
  rarities.forEach(r=>{
    const row=document.createElement('div');row.className='row';
    const left=document.createElement('div');left.textContent=r.name;
    const right=document.createElement('div');
    right.innerHTML=`<span class="chip ${'r-'+r.name.replaceAll(' ','\\ ')}">${r.name}</span>`;
    const sub=document.createElement('div');sub.className='small';
    sub.textContent=`${r.rate}/s ‚Ä¢ $${fmt(r.cost)}`;
    const wrap=document.createElement('div');wrap.append(row,sub);holder.append(wrap);
  });
})();

/* ===== luck shop ===== */
const LUCKS=[
  {name:'2x',mult:2,cost:100000},
  {name:'4x',mult:4,cost:1000000},
  {name:'6x',mult:6,cost:5000000},
  {name:'8x',mult:8,cost:11500000},
  {name:'10x',mult:10,cost:25500000},
  {name:'67x',mult:67,cost:67600000}
];
(function(){
  LUCKS.forEach(l=>{
    const b=document.createElement('button');b.className='btn-mini luck';
    b.textContent=`${l.name} ‚Ä¢ $${fmt(l.cost)}`;
    b.onclick=()=>{
      if(money<l.cost){notify('Not enough money for luck.',false);return;}
      money-=l.cost;currentLuck=l.mult;luckUntil=Date.now()+15*60*1000;
      luckStat.textContent='Luck: '+l.mult+'x';sRare();
      if(l.mult===10){unlockFlags.ruby=true;checkLayoutUnlocks();}
      if(l.mult===67){
        unlockFlags.blue67=true;
        checkLayoutUnlocks();
        if(Math.random()<0.3){
          giveEmojiDirect(OG_TEXT_POOL[Math.floor(Math.random()*OG_TEXT_POOL.length)],'OG');
          notify('Bonus OG from 67x luck!',true);
        }
      }
      updateStats(true);
    };
    const row=document.createElement('div');row.style.margin='2px 0';row.append(b);luckShop.append(row);
  });
})();

/* ===== potion shop ===== */
(function(){
  const b=document.createElement('button');
  b.className='btn-mini';
  b.textContent='üß™ Spawn Potion ‚Ä¢ $10,000';
  b.onclick=()=>{
    const cost=10000;
    if(money<cost){notify('Not enough money for üß™.',false);return;}
    money-=cost;
    spawnBoostUntil=Date.now()+15*60*1000;
    notify('Spawn Potion active: 2√ó spawns for 15 min.',true);
    updateStats(true);
  };
  potionShop.append(b);
})();

/* ===== zoo ===== */
function renderZooShop(){
  zooShop.innerHTML='';
  const all=[...zooAnimals,tRexEmoji];
  all.forEach(e=>{
    const card=document.createElement('div');card.className='zoo-card';
    const em=document.createElement('div');em.className='zoo-emoji';em.textContent=e;
    const rare=(e===tRexEmoji)?'INSANELY TRANSCENDENT':'Epic';
    const rspan=document.createElement('div');rspan.className='small';
    rspan.innerHTML=`<span class="chip ${'r-'+rare.replaceAll(' ','\\ ')}">${rare}</span>`;
    const price=zooPrices[e]||200;
    const priceEl=document.createElement('div');priceEl.className='small';priceEl.textContent=`Safari: ${price}`;
    const btn=document.createElement('button');btn.className='btn-mini zoo';btn.textContent='Adopt';
    btn.onclick=()=>{
      if(safariTokens<price){notify('Not enough Safari Tokens.',false);return;}
      safariTokens-=price;updateSafari();
      const r=rare==='INSANELY TRANSCENDENT'?'INSANELY TRANSCENDENT':'Epic';
      giveEmojiDirect(e,r,true);
      notify('New zoo friend adopted!',true);
    };
    card.append(em,rspan,priceEl,btn);zooShop.append(card);
  });
}
function updateSafari(){
  safariStat.textContent='Safari: '+fmt(Math.floor(safariTokens));
  safariInfo.textContent='Safari Tokens: '+fmt(Math.floor(safariTokens));
  const animals=[...owned.values()].filter(o=>o.isAnimal);
  zooOwned.textContent='Animals: '+animals.length;
}

/* ===== dealer & trader ===== */
const dealerItems=[
  {emoji:'ü•ï',rarity:'Common'},
  {emoji:'üé©',rarity:'Uncommon'},
  {emoji:'ü´ü',rarity:'Rare'},
  {emoji:'üß¢',rarity:'Epic'},
  {emoji:'ü™ñ',rarity:'Legendary'},
  {emoji:'ü´é',rarity:'Mythical'},
  {emoji:'ü™¢',rarity:'Godly'},
  {emoji:'ü™ê',rarity:'Secret'},
  {emoji:'ü™®',rarity:'Insane'},
  {emoji:'üìù',rarity:'Insane'},
  {emoji:'‚úÇÔ∏è',rarity:'Insane'},
  {emoji:'üëª',rarity:'Transcendent'},
  {emoji:'ü™º',rarity:'Transcendent'},
  {emoji:'üêâ',rarity:'INSANELY TRANSCENDENT'},
  {emoji:'ü•©',rarity:'Mythical'}, // Beef
  {emoji:'ü¶É',rarity:'Insane'}    // Turkey
];
function restockDealer(){
  dealerStock=[];
  const pool=[...dealerItems];
  while(dealerStock.length<4 && pool.length){
    const idx=Math.floor(Math.random()*pool.length);
    const it=pool.splice(idx,1)[0];
    const r=rarityByName(it.rarity);
    const price=Math.floor(r.cost*(0.8+Math.random()*0.8));
    dealerStock.push({emoji:it.emoji,rarity:it.rarity,price,bought:0,max:10});
  }
  dealerStatus.textContent='Dealer ready.';
  renderDealer();
}
function renderDealer(){
  dealerGrid.innerHTML='';
  dealerStock.forEach(item=>{
    const card=document.createElement('div');card.className='dealer-card';
    const em=document.createElement('div');em.className='dealer-card-emoji';em.textContent=item.emoji;
    const rspan=document.createElement('div');rspan.className='small';
    rspan.innerHTML=`<span class="chip ${'r-'+item.rarity.replaceAll(' ','\\ ')}">${item.rarity}</span>`;
    const left=(item.max||10)-(item.bought||0);
    const price=document.createElement('div');price.className='small';price.textContent='$'+fmt(item.price)+' ‚Ä¢ left: '+left;
    const btn=document.createElement('button');btn.className='btn-mini buy';btn.textContent='Buy';btn.disabled=left<=0;
    btn.onclick=()=>{
      const remaining=(item.max||10)-(item.bought||0);
      if(remaining<=0){notify('You already bought 10 of this.',false);return;}
      if(money<item.price){notify('Not enough money.',false);return;}
      money-=item.price;item.bought=(item.bought||0)+1;sBuy();
      giveEmojiDirect(item.emoji,item.rarity,false);
      updateStats(true);renderDealer();
    };
    card.append(em,rspan,price,btn);dealerGrid.append(card);
  });
}
setInterval(restockDealer,3*60*1000);

function traderAppear(){
  traderActive=true;traderStock=[];
  const trolls=['üòà','üëπ','üë∫','üíÄ','üëΩ','ü§°','üÜï'];
  for(let i=0;i<2;i++){
    const e=trolls[Math.floor(Math.random()*trolls.length)];
    traderStock.push({emoji:e,rarity:'Troll'});
  }
  const ins=['‚òÉÔ∏è','üé´','ü§π‚Äç‚ôÇÔ∏è','üé≠','üèüÔ∏è','üóº','üè™','üîå','ü™™','üéè','üèÅ','üé®','ü™Å','ü•å','üéØ','üé≥','üöÅ','üöè','üóø','üöß','üõ∞Ô∏è','‚úàÔ∏è','üöÇ','ü©ª','üñåÔ∏è','üí†','üèöÔ∏è','üîä'];
  for(let i=0;i<2;i++){
    const e=ins[Math.floor(Math.random()*ins.length)];
    traderStock.push({emoji:e,rarity:'Insane'});
  }
  traderStock.push({emoji:'üç≥',rarity:'Transcendent'});
  renderTrader();traderStatus.textContent='Trader here (1 trade).';
  setTimeout(()=>{traderActive=false;traderStock=[];traderGrid.innerHTML='';traderStatus.textContent='Trader away.';},15*60*1000);
}
setInterval(traderAppear,60*60*1000);
function renderTrader(){
  traderGrid.innerHTML='';
  if(!traderActive)return;
  traderStock.forEach(item=>{
    const card=document.createElement('div');card.className='trader-card';
    const em=document.createElement('div');em.className='trader-card-emoji';em.textContent=item.emoji;
    const rspan=document.createElement('div');rspan.className='small';
    rspan.innerHTML=`<span class="chip ${'r-'+item.rarity.replaceAll(' ','\\ ')}">${item.rarity}</span>`;
    const txt=document.createElement('div');txt.className='small';txt.textContent='Give 1 '+item.rarity;
    const btn=document.createElement('button');btn.className='btn-mini trade';btn.textContent='Trade';
    btn.onclick=()=>tradeFor(item);
    card.append(em,rspan,txt,btn);traderGrid.append(card);
  });
}
function tradeFor(item){
  if(!traderActive){notify('Trader left.',false);return;}
  const cand=[...owned.values()].find(o=>o.rarity===item.rarity && !o.isAnimal);
  if(!cand){notify('No '+item.rarity+' to trade.',false);return;}
  owned.delete(cand.id);giveEmojiDirect(item.emoji,item.rarity,false);
  traderActive=false;traderStock=[];renderTrader();traderStatus.textContent='Trader away.';
  notify('Trade successful.',true);
}

/* ===== spawn helpers ===== */
function effectiveWeight(r){
  let w=r.weight||0;
  if(currentLuck>1 && ['Legendary','Mythical','Godly','Secret','Exotic','Ultra Exotic','Insane','Transcendent','INSANELY TRANSCENDENT','Newgen','OG'].includes(r.name)){
    w*=currentLuck;
  }
  return w;
}
function pickRandomRarity(){
  const tw=rarities.reduce((s,r)=>s+effectiveWeight(r),0);
  let x=Math.random()*tw;
  for(const r of rarities){
    const w=effectiveWeight(r);if(!w)continue;
    if(x<w)return r;x-=w;
  }
  return rarities[0];
}
function pickEmojiContent(rarityName){
  if(rarityName==='INSANELY TRANSCENDENT'){
    const pool=insanelyTransPool;
    const e=pool[Math.floor(Math.random()*pool.length)];
    return {text:e};
  }
  if(rarityName==='Transcendent'){
    const pool=['ü¶ø','ü´Ü','ü¶æ','üßû‚Äç‚ôÇÔ∏è','üé£','üó∫Ô∏è','üïã','‚õ©Ô∏è','‚õ∞Ô∏è','üèóÔ∏è','üõñ','üèïÔ∏è','üé¢','üé°','üö¶'];
    return {text:pool[Math.floor(Math.random()*pool.length)]};
  }
  if(rarityName==='Newgen'){
    return {text:'TTS'}; // Tung Tung Sahur badge style
  }
  if(rarityName==='OG'){
    if(Math.random()<0.5)return {text:'( Õ°¬∞ Õú ñ Õ°¬∞ )'};
    return {text:OG_TEXT_POOL[Math.floor(Math.random()*OG_TEXT_POOL.length)]};
  }
  if(rarityName.includes('Lucky Block')){
    const icon=rarityName.startsWith('Godly')?'üß∞':rarityName.startsWith('Secret')?'üéÅ':rarityName.startsWith('Insane')?'üé≤':'üíé';
    return {text:icon};
  }
  if(rarityName==='Trick Door'){
    return {text:'üö™'};
  }
  const high=['Legendary','Mythical','Godly','Secret','Exotic','Ultra Exotic','Insane','Transcendent','INSANELY TRANSCENDENT','Newgen','OG'];
  const pool=(high.includes(rarityName)&&Math.random()<0.85)?nichePool:(Math.random()<0.25?nichePool:commonPool);
  const e=pool[Math.floor(Math.random()*pool.length)];
  if(zooAnimals.includes(e))return {text:'üòÄ'}; // animals no longer spawn on road
  return {text:e};
}
function spawnOne(r){
  const span=document.createElement('div');span.className='spawn';
  const lane=Math.random();span.style.top=(lane<0.33?'33%':lane<0.66?'50%':'67%');
  span.dataset.rarity=r.name;span.dataset.cost=r.cost;span.dataset.rate=r.rate;
  span.style.left='-60px';
  const tag=document.createElement('div');tag.className=`tag ${'r-'+r.name.replaceAll(' ','\\ ')}`;tag.textContent=r.name;
  span.append(tag);
  const c=pickEmojiContent(r.name);
  span.append(document.createTextNode(c.text));span.dataset.emojiText=c.text;
  roadEl.append(span);
  if(['Secret','Exotic','Ultra Exotic','Insane','Transcendent','INSANELY TRANSCENDENT','Newgen','OG'].includes(r.name)){notify(r.name+' spawned!',true);sRare();}
  let x=-60;
  const speed=(r.name==='OG'?0.7:r.name==='Newgen'?0.75:r.name==='INSANELY TRANSCENDENT'?0.8:0.9+Math.random()*0.7);
  function move(){
    if(!paused){x+=speed;span.style.left=x+'px';}
    if(x>roadEl.clientWidth+30){span.remove();cancelAnimationFrame(raf);}
    else{raf=requestAnimationFrame(move);}
  }
  let raf=requestAnimationFrame(move);
}
function scheduleRandom(){
  setInterval(()=>{
    spawnOne(pickRandomRarity());
    if(Date.now()<spawnBoostUntil)spawnOne(pickRandomRarity());
  },6500);
}
function scheduleGuaranteed(){
  setInterval(()=>spawnOne(rarityByName('Legendary')),5*60*1000);
  setInterval(()=>spawnOne(rarityByName('Mythical')),10*60*1000);
  setInterval(()=>spawnOne(rarityByName('Godly')),30*60*1000);
  setInterval(()=>spawnOne(rarityByName('OG')),3*60*60*1000);
}

/* ===== economy ===== */
function tryBuy(span){
  const rarity=span.dataset.rarity;
  const cost=+span.dataset.cost||0;
  if(money<cost){notify('Need $'+fmt(cost),false);return;}
  money-=cost;
  const text=span.dataset.emojiText||span.textContent.trim();
  if(rarity==='Trick Door'){
    giveEmojiDirect(text,'Trick Door',false,true);
  }else{
    addOwned({id:nextId++,emoji:text,rarity,baseRate:+span.dataset.rate||0,level:1,isAnimal:false,isDoor:false});
  }
  span.remove();sBuy();updateStats(true);
}
function currentRate(){
  let r=0;owned.forEach(o=>{if(!o.isAnimal)r+=o.baseRate*(1+(o.level-1)*0.25);});
  return r*multiplier*eventMultiplier;
}
function tickIncome(){
  setInterval(()=>{
    money+=currentRate();
    const animalCount=[...owned.values()].filter(o=>o.isAnimal).length;
    safariTokens+=animalCount*0.2;
    updateStats();
    updateSafari();
  },1000);
}

/* ===== owned / base ===== */
function addOwned(o){
  owned.set(o.id,o);
  collectedEmojis.add(o.emoji);
  drawOwned();
  refreshWorkshops();
  updateSafari();
  updateIndex();
  checkLayoutUnlocks();
}
function giveEmojiDirect(emoji,rarity,isAnimal=false,isDoor=false){
  const r=rarityByName(rarity) || {rate:0};
  if(isDoor){
    const obj={id:nextId++,emoji,rarity:'Trick Door',baseRate:0,level:1,isAnimal:false,isDoor:true};
    addOwned(obj);return;
  }
  let baseRateVal;
  if(isAnimal){
    baseRateVal=(emoji===tRexEmoji)?5000:0; // T-rex earns big
  }else{
    baseRateVal=r.rate||0;
  }
  const obj={id:nextId++,emoji,rarity,baseRate:baseRateVal,level:1,isAnimal,isDoor:false};
  addOwned(obj);
}
function drawOwned(){
  baseEl.innerHTML='';
  const list=[...owned.values()].sort((a,b)=>b.baseRate-a.baseRate);
  list.forEach(o=>{
    const card=document.createElement('div');card.className='card';
    const big=document.createElement('div');big.className='big';big.textContent=o.emoji;
    const body=document.createElement('div');body.style.flex='1';
    const h4=document.createElement('h4');h4.textContent=`${o.rarity} Lv.${o.level}`;
    const small=document.createElement('div');small.className='small';
    if(o.isAnimal && o.emoji===tRexEmoji)small.textContent='T-Rex ‚Ä¢ Money + Safari over time';
    else if(o.isAnimal)small.textContent='Zoo animal ‚Ä¢ +Safari over time';
    else if(o.isDoor)small.textContent='Open for candy & ghost!';
    else small.textContent=`${fmt(o.baseRate*(1+(o.level-1)*0.25)*multiplier*eventMultiplier)}/s`;
    const buttons=document.createElement('div');buttons.className='row-btns';
    if(o.isDoor){
      const open=document.createElement('button');open.className='btn-mini door';open.textContent='Open';
      open.onclick=()=>openDoor(o.id);buttons.append(open);
    }else if(!o.isAnimal){
      const feed=document.createElement('button');feed.className='btn-mini feed';feed.textContent='Feed';
      feed.onclick=()=>openFeedDialog(o.id);buttons.append(feed);
    }
    const sell=document.createElement('button');sell.className='btn-mini sell';sell.textContent='Sell';
    sell.onclick=()=>{
      const r=rarityByName(o.rarity)||{cost:100};
      const base=o.baseRate?o.baseRate*40:r.cost;
      money+=Math.floor(base*0.5);
      owned.delete(o.id);
      drawOwned();updateStats(true);refreshWorkshops();updateSafari();
    };
    buttons.append(sell);
    body.append(h4,small,buttons);card.append(big,body);baseEl.append(card);
  });
}

/* lucky blocks + door open */
function weightedPick(p){const total=p.reduce((a,b)=>a+b.w,0);let x=Math.random()*total;for(const e of p){if(x<e.w)return e.r;x-=e.w;}return p[0].r;}
function openLuckyBlock(id,name){
  const o=owned.get(id);if(!o)return;
  const table=LUCKY_SETS[name];if(!table){notify('No loot.',false);return;}
  const result=weightedPick(table);
  const r=rarityByName(result);
  owned.delete(id);
  const em=pickEmojiContent(result).text;
  giveEmojiDirect(em,result,false);
  notify(`Opened ${name} ‚Üí ${result}`,true);
}
function openDoor(id){
  const o=owned.get(id);if(!o)return;
  const loot=openDoorLoot();
  owned.delete(id);
  giveEmojiDirect(loot.emoji,loot.rarity,false);
  notify(`Trick Door gave ${loot.emoji} (${loot.rarity})`,true);
}

/* feed */
function openFeedDialog(targetId){
  const modal=document.createElement('div');
  Object.assign(modal.style,{position:'fixed',inset:'0',background:'rgba(0,0,0,.5)',display:'grid',placeItems:'center',zIndex:9998});
  const box=document.createElement('div');
  Object.assign(box.style,{background:'#0e111b',border:'1px solid #303653',borderRadius:'12px',padding:'10px',width:'min(420px,92vw)',fontSize:'13px'});
  box.innerHTML='<b>Feed emoji</b><br><span class="small">Higher rarity snack = +2 levels, else +1.</span>';
  const select=document.createElement('select');select.style.width='100%';select.style.margin='8px 0';select.style.padding='6px';
  const o0=document.createElement('option');o0.value='';o0.textContent='Choose emoji to consume‚Ä¶';select.append(o0);
  owned.forEach(o=>{if(o.id===targetId||o.isAnimal||o.isDoor)return;const op=document.createElement('option');op.value=o.id;op.textContent=`${o.emoji} (${o.rarity})`;select.append(op);});
  const row=document.createElement('div');row.style.display='flex';row.style.justifyContent='flex-end';row.style.gap='6px';
  const cancel=document.createElement('button');cancel.className='btn-mini';cancel.textContent='Cancel';cancel.onclick=()=>modal.remove();
  const feed=document.createElement('button');feed.className='btn-mini feed';feed.textContent='Feed';
  feed.onclick=()=>{
    const id=+select.value;if(!id){notify('Pick something.',false);return;}
    const target=owned.get(targetId),snack=owned.get(id);if(!target||!snack){modal.remove();return;}
    const idx=name=>rarities.findIndex(r=>r.name===name);
    const add=idx(snack.rarity)>idx(target.rarity)?2:1;
    target.level+=add;money+=Math.floor(snack.baseRate*10);
    owned.delete(id);modal.remove();drawOwned();updateStats(true);refreshWorkshops();
  };
  row.append(cancel,feed);box.append(select,row);modal.append(box);document.body.append(modal);
}

/* fuse */
let fuseSelected=new Set();
function refreshFuse(){
  fuseSelected.clear();fuseCountPill.textContent='Selected: 0/4';fuseListEl.innerHTML='';
  const group={};
  owned.forEach(o=>{
    if(o.isAnimal||o.isDoor)return;
    if(o.rarity.includes('Lucky Block')||o.rarity==='OG'||o.rarity==='Newgen')return;
    (group[o.rarity]??=[]).push(o);
  });
  const keys=Object.keys(group);
  fuseHint.textContent=keys.length?'Select 4 of same rarity.':'Need emojis first.';
  keys.forEach(rname=>{
    const items=group[rname],wrap=document.createElement('div');
    wrap.style.border='1px solid #20233a';wrap.style.borderRadius='9px';wrap.style.padding='6px';
    const title=document.createElement('div');title.innerHTML=`<b>${rname}</b> (${items.length})`;
    const list=document.createElement('div');
    list.style.display='grid';list.style.gridTemplateColumns='repeat(auto-fill,minmax(42px,1fr))';list.style.gap='4px';list.style.marginTop='4px';
    items.forEach(o=>{
      const b=document.createElement('button');b.className='btn-mini';b.style.padding='4px';b.textContent=o.emoji;
      b.onclick=()=>{
        if(fuseSelected.has(o.id)){fuseSelected.delete(o.id);b.style.outline='none';}
        else if(fuseSelected.size<4){fuseSelected.add(o.id);b.style.outline='2px solid #4fd1c5';}
        fuseCountPill.textContent=`Selected: ${fuseSelected.size}/4`;
      };
      list.append(b);
    });
    wrap.append(title,list);fuseListEl.append(wrap);
  });
}
const nextMap={
  'Common':'Uncommon','Uncommon':'Rare','Rare':'Epic','Epic':'Legendary',
  'Legendary':'Mythical','Mythical':'Godly','Godly':'Secret','Secret':'Exotic',
  'Exotic':'Ultra Exotic','Ultra Exotic':'Insane','Troll':'Insane',
  'Insane':'Transcendent','Transcendent':'INSANELY TRANSCENDENT',
  'INSANELY TRANSCENDENT':'Newgen','Newgen':'OG'
};
function nextRarityName(name){return nextMap[name]||null;}
fuseBtn.onclick=()=>{
  if(fuseSelected.size!==4){notify('Need exactly 4.',false);return;}
  let rname=null,ok=true;const ids=[...fuseSelected];
  ids.forEach((id,i)=>{const o=owned.get(id);if(!o)ok=false;if(i===0)rname=o.rarity;if(o&&o.rarity!==rname)ok=false;});
  if(!ok){notify('All 4 must match rarity.',false);return;}
  const next=nextRarityName(rname);if(!next){notify('Cannot fuse higher.',false);return;}
  ids.forEach(id=>owned.delete(id));
  const em=pickEmojiContent(next).text;
  giveEmojiDirect(em,next,false);
  notify(`Fused 4 √ó ${rname} ‚Üí ${next}`,true);
  refreshFuse();updateStats(true);
};

/* crafts (ALL your combos) */
const recipes=[
  {label:'üôÅ + üôÅ ‚Üí üò≠ (Epic)',in:[['üôÅ',2]],out:{emoji:'üò≠',rarity:'Epic'}},
  {label:'‚ù§Ô∏è + üî• ‚Üí ‚ù§Ô∏è‚Äçüî• (Mythical)',in:[['‚ù§Ô∏è',1],['üî•',1]],out:{emoji:'‚ù§Ô∏è‚Äçüî•',rarity:'Mythical'}},
  {label:'ü¶É√ó4 + üî•√ó4 + ‚ù§Ô∏è‚Äçüî•√ó3 ‚Üí üê¶‚Äçüî• (INSANE T)',in:[['ü¶É',4],['üî•',4],['‚ù§Ô∏è‚Äçüî•',3]],out:{emoji:'üê¶‚Äçüî•',rarity:'INSANELY TRANSCENDENT'}},
  {label:'ü™® + üìù + ‚úÇÔ∏è ‚Üí ü™®üìÑ‚úÇÔ∏è (Transcendent)',in:[['ü™®',1],['üìù',1],['‚úÇÔ∏è',1]],out:{emoji:'ü™®üìÑ‚úÇÔ∏è',rarity:'Transcendent'}},
  {label:'üí∏√ó8 + üí∞√ó5 ‚Üí ü§ë (Transcendent)',in:[['üí∏',8],['üí∞',5]],out:{emoji:'ü§ë',rarity:'Transcendent'}},
  {label:'üê∑ + üêñ√ó2 ‚Üí üêó (Mythical)',in:[['üê∑',1],['üêñ',2]],out:{emoji:'üêó',rarity:'Mythical'}},
  {label:'üîû + üçá ‚Üí üç∑ (Epic)',in:[['üîû',1],['üçá',1]],out:{emoji:'üç∑',rarity:'Epic'}},
  {label:'ü•à + ü•â ‚Üí ü•á (Rare)',in:[['ü•à',1],['ü•â',1]],out:{emoji:'ü•á',rarity:'Rare'}},
  {label:'ü•á + ü•á ‚Üí üéñÔ∏è (Epic)',in:[['ü•á',2]],out:{emoji:'üéñÔ∏è',rarity:'Epic'}},
  {label:'üéñÔ∏è + üéñÔ∏è ‚Üí üèÖ (Legendary)',in:[['üéñÔ∏è',2]],out:{emoji:'üèÖ',rarity:'Legendary'}},
  {label:'üèÖ√ó3 + ü•á + üéñÔ∏è ‚Üí üèÜ (Mythical)',in:[['üèÖ',3],['ü•á',1],['üéñÔ∏è',1]],out:{emoji:'üèÜ',rarity:'Mythical'}},
  {label:'üé≤ + üß© ‚Üí üé∞ (Transcendent)',in:[['üé≤',1],['üß©',1]],out:{emoji:'üé∞',rarity:'Transcendent'}},
  {label:'üí∫√ó10 + üöù + üöÅ ‚Üí üõ©Ô∏è (Transcendent)',in:[['üí∫',10],['üöù',1],['üöÅ',1]],out:{emoji:'üõ©Ô∏è',rarity:'Transcendent'}},
  {label:'üí∞√ó18 + üí∏ + üíµ√ó16 ‚Üí üè¶ (Transcendent)',in:[['üí∞',18],['üí∏',1],['üíµ',16]],out:{emoji:'üè¶',rarity:'Transcendent'}},
  {label:'üíØ + üÖ∞Ô∏è + ‚ÅâÔ∏è ‚Üí @ (OG)',in:[['üíØ',1],['üÖ∞Ô∏è',1],['‚ÅâÔ∏è',1]],out:{emoji:'@',rarity:'OG'}},
  {label:'üè† + üå™Ô∏è ‚Üí üèöÔ∏è (Rare)',in:[['üè†',1],['üå™Ô∏è',1]],out:{emoji:'üèöÔ∏è',rarity:'Rare'}},
  {label:'üé° + üèóÔ∏è + üõ§Ô∏è ‚Üí üé¢ (Epic)',in:[['üé°',1],['üèóÔ∏è',1],['üõ§Ô∏è',1]],out:{emoji:'üé¢',rarity:'Epic'}},
  {label:'ü•ö + üê• ‚Üí üê£ (Uncommon)',in:[['ü•ö',1],['üê•',1]],out:{emoji:'üê£',rarity:'Uncommon'}},
  {label:'üìé + üìé ‚Üí üñáÔ∏è (Uncommon)',in:[['üìé',2]],out:{emoji:'üñáÔ∏è',rarity:'Uncommon'}},
  {label:'üéØ + üì• ‚Üí üßÆ (Rare)',in:[['üéØ',1],['üì•',1]],out:{emoji:'üßÆ',rarity:'Rare'}}
];
function emojiCounts(){
  const c={};owned.forEach(o=>{if(!o.emoji)return;c[o.emoji]=(c[o.emoji]||0)+1;});return c;
}
function refreshCraft(){
  craftList.innerHTML='';
  const counts=emojiCounts();
  recipes.forEach(rec=>{
    const row=document.createElement('div');
    row.style.border='1px solid #232738';row.style.borderRadius='9px';row.style.padding='4px';
    const top=document.createElement('div');top.className='small';top.textContent=rec.label;
    const can=Math.min(...rec.in.map(([em,n])=>Math.floor((counts[em]||0)/n)||0));
    const bottom=document.createElement('div');bottom.style.display='flex';bottom.style.justifyContent='space-between';bottom.style.alignItems='center';bottom.style.marginTop='2px';
    const pill=document.createElement('span');pill.className='pill';pill.textContent='Can craft: '+can;
    const btn=document.createElement('button');btn.className='btn-mini';btn.textContent='Craft';btn.disabled=!can;
    btn.onclick=()=>doCraft(rec);
    bottom.append(pill,btn);row.append(top,bottom);craftList.append(row);
  });
}
function doCraft(rec){
  const counts=emojiCounts();
  for(const [em,n] of rec.in){if((counts[em]||0)<n){notify('Not enough pieces.',false);return;}}
  const toRemove=[];
  rec.in.forEach(([em,n])=>{
    let need=n;owned.forEach(o=>{if(need>0 && o.emoji===em){toRemove.push(o.id);need--;}}); 
  });
  toRemove.forEach(id=>owned.delete(id));
  giveEmojiDirect(rec.out.emoji,rec.out.rarity,false);
  notify('Crafted: '+rec.label,true);
  refreshWorkshops();updateStats(true);
}

/* dragon shrine (Beef) + Dragon Awakening event */
dragonBtn.onclick=()=>{
  const beef=[...owned.values()].find(o=>o.emoji==='ü•©');
  if(!beef){notify('You need 1 Beef ü•© (Mythic).',false);return;}
  owned.delete(beef.id);
  const gotDragon=Math.random()<0.000003?true:(Math.random()<0.0001);
  if(gotDragon){
    giveEmojiDirect('üêâ','INSANELY TRANSCENDENT',false);
    notify('The Dragon Lord grants you üêâ!',true);sRare();
    setEvent('Dragon Awakening',11.35,10*60*1000);
  }else{
    notify('Dragon Lord refuses. Maybe next time‚Ä¶',false);
  }
  updateBeefCount();
};
function updateBeefCount(){
  const beefCount=[...owned.values()].filter(o=>o.emoji==='ü•©').length;
  beefCountPill.textContent='Beef: '+beefCount;
}

/* Phoenix Rebirth */
phoenixBtn.onclick=()=>{
  const moneyReq=10000000;
  if(money<moneyReq){notify('Need $10,000,000 for Phoenix Rebirth.',false);return;}
  const trans=[...owned.values()].filter(o=>o.rarity==='Transcendent'||o.rarity==='INSANELY TRANSCENDENT');
  if(trans.length<3){notify('Need 3 Transcendents/ITs.',false);return;}
  const turkey=[...owned.values()].find(o=>o.emoji==='ü¶É');
  if(!turkey){notify('Need 1 ü¶É (Insane).',false);return;}
  if(!confirm('Phoenix Rebirth: lose everything for a guaranteed üê¶‚Äçüî•?\n(This will hard reset your progress.)'))return;
  money=0;owned.clear();multiplier=1;rebirths=0;
  giveEmojiDirect('üê¶‚Äçüî•','INSANELY TRANSCENDENT',false);
  achievements.phoenix=true;
  drawOwned();refreshWorkshops();updateBeefCount();updateSafari();updateAchievements();updateStats(true);
  checkLayoutUnlocks();
  notify('Phoenix Rebirth complete! üê¶‚Äçüî•',true);
};
function updateAchievements(){
  const list=[];
  if(achievements.phoenix)list.push('üî• The Phoenix Rebirth');
  achievementsBox.textContent=list.length?list.join(', '):'None yet.';
}

/* rebirth */
function doRebirth(){
  const cost=Math.floor(100000*Math.pow(2,rebirths));
  if(money<cost){notify('Need $'+fmt(cost)+' to rebirth.',false);return;}
  if(!confirm('Rebirth for +50% income?\nCost: $'+fmt(cost)))return;
  money=0;owned.clear();multiplier=+((1+(rebirths+1)*0.5).toFixed(2));rebirths++;
  drawOwned();refreshWorkshops();updateBeefCount();updateSafari();updateStats(true);
}

/* events system */
function setEvent(name,mult,ms){
  activeEvent=name;
  eventMultiplier=mult;
  eventUntil=Date.now()+ms;
  eventStat.textContent='Event: '+name+' x'+mult.toFixed(2);
  document.body.dataset.event=name.replace(/\s+/g,'-').toLowerCase();
  notify(name+' event started! x'+mult.toFixed(2),true);
}
function clearEvent(){
  if(!activeEvent)return;
  activeEvent=null;
  eventMultiplier=1;
  eventUntil=0;
  eventStat.textContent='Event: none';
  document.body.dataset.event='';
}
function randomEventsLoop(){
  setInterval(()=>{
    if(activeEvent)return;
    const roll=Math.random();
    if(roll<0.0000067){ // 0.00067%
      setEvent('67',1.676,5*60*1000);
    }else if(roll<0.0000067+0.0005){
      setEvent('Disco',8.5,5*60*1000);
    }else if(roll<0.0000067+0.0005+0.001){
      setEvent('Blood Moon',4.5,7*60*1000);
    }else if(roll<0.0000067+0.0005+0.001+0.002){
      setEvent('Moon',3,7*60*1000);
    }else if(roll<0.0000067+0.0005+0.001+0.002+0.0015){
      setEvent('Volcano',5,6*60*1000);
    }
  },30000);
}

/* stats + notify */
function fmt(n){return n.toLocaleString();}
function updateStats(pulse){
  const now=Date.now();
  if(now>luckUntil){currentLuck=1;luckStat.textContent='Luck: 1x';}
  if(eventUntil && now>eventUntil){clearEvent();}
  cashStat.textContent='$'+fmt(Math.floor(money));
  rateStat.textContent=fmt(Math.floor(currentRate()))+' / sec';
  rebirthStat.textContent='Rebirths: '+rebirths+' (x'+multiplier.toFixed(2)+')';
  if(pulse){cashStat.classList.add('money-up');setTimeout(()=>cashStat.classList.remove('money-up'),400);}
}
function notify(html,good){
  const t=document.createElement('div');t.className='t';
  t.innerHTML=(good?'‚úÖ ':'‚ÑπÔ∏è ')+html;if(!good)t.style.borderColor='#52303b';
  toastEl.append(t);setTimeout(()=>t.remove(),5200);
}

/* index + layouts */
function buildIndexList(){
  const s=new Set();
  commonPool.forEach(e=>s.add(e));
  nichePool.forEach(e=>s.add(e));
  insanelyTransPool.forEach(e=>s.add(e));
  zooAnimals.forEach(e=>s.add(e));
  FRUITS.forEach(e=>s.add(e));
  dealerItems.forEach(it=>s.add(it.emoji));
  recipes.forEach(rec=>{
    rec.in.forEach(([em])=>s.add(em));
    s.add(rec.out.emoji);
  });
  s.add(tRexEmoji);
  s.add('TTS');
  s.add('( Õ°¬∞ Õú ñ Õ°¬∞ )');
  s.add('@');
  indexAllEmojis=[...s];
}
function updateIndex(){
  if(!indexAllEmojis.length)return;
  indexGrid.innerHTML='';
  let ownedCount=0;
  indexAllEmojis.forEach(em=>{
    const has=collectedEmojis.has(em);
    if(has)ownedCount++;
    const cell=document.createElement('div');
    cell.className='index-cell'+(has?' owned':'');
    const span=document.createElement('span');span.textContent=em;
    cell.append(span);indexGrid.append(cell);
  });
  indexSummary.textContent=ownedCount+' / '+indexAllEmojis.length+' collected';
}
function setLayoutLocked(id,locked){
  layoutButtons.forEach(btn=>{
    if(btn.dataset.layout===id){
      if(locked)btn.classList.add('locked');else btn.classList.remove('locked');
    }
  });
}
function checkLayoutUnlocks(){
  const hasFruit=FRUITS.every(e=>collectedEmojis.has(e));
  setLayoutLocked('fruit',!hasFruit);

  const ownedTransCount=[...owned.values()].filter(o=>o.rarity==='Transcendent'||o.rarity==='INSANELY TRANSCENDENT').length;
  const hasNeon=ownedTransCount>=20;
  setLayoutLocked('neon',!hasNeon);

  const hasRainbow=money>=10000000;
  setLayoutLocked('rainbow',!hasRainbow);

  setLayoutLocked('magma',!achievements.phoenix);
  setLayoutLocked('ruby',!unlockFlags.ruby);
  setLayoutLocked('blue67',!unlockFlags.blue67);

  const hasUnderwater=OCEAN_SET.every(e=>collectedEmojis.has(e));
  setLayoutLocked('underwater',!hasUnderwater);

  const allCollected=indexAllEmojis.length && indexAllEmojis.every(e=>collectedEmojis.has(e));
  setLayoutLocked('future',!allCollected);

  const hasBlack61=collectedEmojis.size>=61;
  setLayoutLocked('black61',!hasBlack61);
}
function applyLayout(){
  const root=document.documentElement;
  function setTheme(bg1,bg2,panel,road,text){
    root.style.setProperty('--bg1',bg1);
    root.style.setProperty('--bg2',bg2);
    root.style.setProperty('--panel',panel);
    root.style.setProperty('--panel-soft',panel);
    root.style.setProperty('--road',road);
    root.style.setProperty('--text',text);
  }
  switch(layoutMode){
    case 'blue':
      setTheme('#020617','#0f172a','#020617','#0ea5e9','#e5f6ff');
      break;
    case 'red':
      setTheme('#0b0c12','#0f0f13','#171922','#cc1f1f','#e9ecf1');
      break;
    case 'white':
      setTheme('#e5e7eb','#f9fafb','#ffffff','#e5e7eb','#050716');
      break;
    case 'fruit':
      setTheme('#022c22','#064e3b','#022c22','#16a34a','#ecfdf5');
      break;
    case 'neon':
      setTheme('#020617','#020617','#020617','#22c55e','#e0f2fe');
      break;
    case 'rainbow':
      setTheme('#020617','#111827','#111827','linear-gradient(90deg,#ef4444,#eab308,#22c55e,#3b82f6,#8b5cf6)','#f9fafb');
      break;
    case 'magma':
      setTheme('#020617','#111827','#111827','#b91c1c','#fee2e2');
      break;
    case 'ruby':
      setTheme('#020617','#111827','#111827','#be123c','#fecaca');
      break;
    case 'blue67':
      setTheme('#020617','#020617','#020617','#0ea5e9','#e0f2fe');
      break;
    case 'underwater':
      setTheme('#020617','#02101f','#021827','#0369a1','#e0f2fe');
      break;
    case 'black61':
      setTheme('#02010a','#06010f','#07010f','#7f1d1d','#fef2f2');
      break;
    case 'future':
      setTheme('#020617','#020617','#020617','#22c55e','#e5f6ff');
      break;
  }
}

/* save/load */
function saveGame(){
  const data={
    money,rebirths,multiplier,nextId,currentLuck,luckUntil,safariTokens,achievements,
    owned:[...owned.values()],
    layoutMode,unlockFlags,
    collected:[...collectedEmojis]
  };
  try{localStorage.setItem('emojiRoadSaveZoo',JSON.stringify(data));}catch(e){}
}
function loadGame(){
  try{
    const raw=localStorage.getItem('emojiRoadSaveZoo');if(!raw)return;
    const d=JSON.parse(raw);
    money=d.money||0;rebirths=d.rebirths||0;multiplier=d.multiplier||1;nextId=d.nextId||1;
    currentLuck=d.currentLuck||1;luckUntil=d.luckUntil||0;
    safariTokens=d.safariTokens||0;
    achievements=d.achievements||{phoenix:false};
    layoutMode=d.layoutMode||'red';
    unlockFlags=d.unlockFlags||{ruby:false,blue67:false};
    collectedEmojis=new Set(d.collected||[]);
    owned.clear();
    (d.owned||[]).forEach(o=>{owned.set(o.id,o);collectedEmojis.add(o.emoji);});
    drawOwned();refreshWorkshops();updateBeefCount();updateSafari();updateAchievements();updateStats(true);
    updateIndex();checkLayoutUnlocks();applyLayout();
  }catch(e){}
}
setInterval(saveGame,10000);

/* bootstrap */
function refreshWorkshops(){refreshFuse();refreshCraft();}
function bootstrap(){
  buildIndexList();
  loadGame();
  if(owned.size===0 && money===0)money=250;
  updateStats(true);updateSafari();updateAchievements();updateBeefCount();
  applyLayout();
  scheduleRandom();scheduleGuaranteed();tickIncome();randomEventsLoop();
  for(let i=0;i<3;i++)spawnOne(pickRandomRarity());
  restockDealer();renderZooShop();refreshWorkshops();
  setTimeout(traderAppear,15000);
}
bootstrap();
</script>
</body>
</html>
